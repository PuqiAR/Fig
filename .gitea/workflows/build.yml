name: Release Build
on:
  push:
    tags: ['*']
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  build:
    runs-on: ubuntu
    container:
      image: alpine:latest
      options: >-
        --dns 223.5.5.5
        --dns 223.6.6.6

    steps:
      # 1. è¶…å¿«é€Ÿå®‰è£…ï¼šå›½å†…é•œåƒæº + æœ€å°ä¾èµ–é›†
      - name: ğŸš€ æé€Ÿå®‰è£…ä¾èµ–
        run: |
          # æ›¿æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒæºï¼ˆå›½å†…è®¿é—®æå¿«ï¼‰
          sed -i 's|dl-cdn.alpinelinux.org|mirrors.aliyun.com|g' /etc/apk/repositories
          
          # åªå®‰è£…æœ€æ ¸å¿ƒçš„æ„å»ºå·¥å…·
          apk update --no-cache
          apk add --no-cache --virtual .build-deps \
            gcc \
            g++ \
            make \
            musl-dev \
            linux-headers \
            curl \
            tar
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œè€—æ—¶çº¦30ç§’"
          
      # 2. å¹¶è¡Œå®‰è£…xmakeï¼ˆä¸ç­‰å¾…gitï¼‰
      - name: âš¡ å®‰è£…xmake
        run: |
          curl --retry 3 --connect-timeout 10 -fsSL https://xmake.io/shget.text | bash
          echo "/root/.local/bin" >> $GITHUB_PATH
          /root/.local/bin/xmake --version
          
      # 3. è·å–ä»£ç ï¼ˆä½¿ç”¨actå†…ç½®çš„æ£€å‡ºæœºåˆ¶ï¼‰
      - name: ğŸ“¦ è·å–ä»£ç 
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          
      # 4. å¿«é€Ÿè®¾ç½®ç‰ˆæœ¬
      - name: ğŸ·ï¸ è®¾ç½®ç‰ˆæœ¬
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          fi
          echo "ç‰ˆæœ¬: ${{ env.VERSION }}"
          
      # 5. æ„å»º
      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: |
          xmake f -p linux -a x86_64 -m release -y
          xmake build -j$(nproc)
          
      # 6. æ‰“åŒ…
      - name: ğŸ“¦ æ‰“åŒ…æ–‡ä»¶
        run: |
          DIR="Fig-${{ env.VERSION }}-linux-x86_64"
          mkdir -p "$DIR"
          cp build/linux/x86_64/release/Fig "$DIR/"
          [ -d "src/Module/Library" ] && cp -r src/Module/Library "$DIR/"
          tar -czf "$DIR.tar.gz" "$DIR"
          sha256sum "$DIR.tar.gz" > "$DIR.sha256"
          ls -lh Fig-*
          
      # 7. å‘å¸ƒ
      - name: ğŸ“¤ å‘å¸ƒåˆ°Gitea
        env:
          TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          VERSION="${{ env.VERSION }}"
          API="https://git.fig-lang.cn/api/v1/repos/${{ github.repository }}"
          
          # å¿«é€Ÿå‘å¸ƒ
          curl -m 30 -sSf -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$VERSION\"}" \
            "$API/releases" 2>/dev/null || true
          
          # å¿«é€Ÿä¸Šä¼ 
          curl -m 60 -sSf -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @Fig-$VERSION-linux-x86_64.tar.gz \
            "$API/releases/$VERSION/assets?name=Fig-$VERSION-linux-x86_64.tar.gz"
          
          curl -m 30 -sSf -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: text/plain" \
            --data-binary @Fig-$VERSION-linux-x86_64.sha256 \
            "$API/releases/$VERSION/assets?name=Fig-$VERSION-linux-x86_64.sha256"
          
          echo "âœ… å‘å¸ƒå®Œæˆï¼"